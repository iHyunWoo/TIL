# V8 엔진
- 구글이 개발한 JS 엔진으로 Chrome, NodeJS에서 사용

## 동작 원리
![[v8-engine.png]]
1. Parser가 소소 코드를 분석하여 AST와 스코프를 생성
2. 인터프리터가 AST를 기반으로 바이트 코드 생성
3. 바이트코드를 기반으로 코드를 실행하며, 실행 중 프로파일 정보를 수집
4. 수집된 프로파일 정보를 토대로 자주 사용되는 코드를 최적화하여 컴파일
## 1. 파싱
- 파싱이란 소스 코드를 추상 구문 트리(AST)로 변환하는 과정
- AST는 코드의 문법적 구조를 트리로 나타낸 자료구조
- 파싱에 소요되는 시간을 줄이기 위해 V8은 두 가지 파싱 전략을 사용
	- parser (eagle):
	    - 실행하는데 필요한 구문을 파싱하고 AST를 생성
	- pre-parser (lazy):
		- 당장 필요하지 않은 코드를 빠르게 검사만 하고 넘어가고, 실제로 그 코드가 필요할 때가 되어서야 완전한 파싱을 수행
		- 코드의 기본적인 구조만을 신속하게 파악하여 초기 파싱 시간을 단축
## 2. 바이트 코드 생성
- 파싱 단계를 거쳐 생성된 AST를 기반으로, V8는 Ignition 인터프리터를 통해 바이트코드로 변환
- 바이트 코드는 실제 기계어는 아니지만, 인터프리터가 실행하기 쉽게 최적화된 중간 형태의 코드
- 이 과정에서 V8은 몇 가지 최적화를 수행
	- 예) `const a = 1 + 2`를 `const a = 3`으로 최적화

## 3. JIT 컴파일과 최적화
- V8의 Just-In-Time 컴파일은 JavaScript 코드를 실행하면서 필요한 시점에 기계어로 변환하는 방식
- Ignition이 생성한 바이트코드는 처음에는 인터프리터에 의해 실행되지만, 자주 실행되는 코드(hot code)를 발견하면 TurboFan 컴파일러가 최적화된 기계어로 변환
- Deoptimization
	- 최적화된 코드를 폐기하고 다시 Ignition의 바이트 코드로 돌아가는 것
	- JS는 동적 타입언어이기 때문에, 이전과 다른 타입의 데이터가 들어오면, V8은 최적화된 코드를 폐기하고 다시 Ignition으로 실행을 전환함.
	- 또한, 객체의 새로운 속성을 추가하거나 속성의 타입이 변경되어도 deoptimization 발생


### 3-1. TurboFan의 최적화 기법
- 히든 클래스
	- JS는 타입이 존재 하지 않지만, 같은 모양의 객체가 존재 할 수 있음
	- 히든 클래스는 객체의 구조를 추적하는 내부 표현으로, 같은 구조를 가진 객체들이 이 정보를 공유함
	- DescriptorArray와 TransitionArray라는 두 가지 배열을 사용
		- DescriptorArray는 객체의 프로퍼티 목록과 각 프로퍼티의 정보(위치, 속성 등)를 저장
		- TransitionArray는 객체에 새로운 프로퍼티가 추가될 때 어떤 히든 클래스로 전환되어야 하는지를 추적
	- 예) 빈 객체에 name 프로퍼티를 추가하면 새로운 히든 클래스로 전환. 여기에 또 age 프로퍼티를 추가하면 또 새로운 히든 클래스로 전환
- 인라인 캐싱
	- 객체의 프로퍼티를 찾는 위치를 기억하는 방식
	- 어떤 함수가 객체의 특정 프로퍼티에 반복적으로 접근한다면, V8은 이 프로퍼티의 위치를 캐싱
	- 같은 히든 클래스를 가진 객체가 이 함수를 호출할 때 프로퍼티를 다시 찾지 않고 캐싱된 위치 정보 사용
			
## 4. 비최적화 컴파일러
- V8 버전 9.1부터 기존의 Ignition과 TurboFan의 중간 단계에 위치한 Sparkplug라는 비최적화 컴파일러 도입
- 도입 이유
	- Ignition 인터프리터에 너무 오래 머무르면 성능 향상의 효과를 누릴 수 없음
	- 반대로 TurboFan을 통해 너무 빨리 최적화를 해버리면 실제로 아직 hot 하지 않은 함수를 최적화할 수 있고, deoptimize 상황이 발생할 수 있음
- Sparkplug는 AST가 아닌 Ignition이 생성한 바이트 코드를 기반으로 기계어 코드를 만들어내고 별도의 최적화 작업을 수행하지 않기 때문에 빠르게 실행할 수 있음


## Reference
- [구글 V8 엔진 살펴보기](https://jaehyeon48.github.io/javascript/google-v8-engine/)
- [히든 클래스와 인라인 캐싱](https://jaehyeon48.github.io/javascript/hidden-class-ic/)
- [V8 엔진](https://laurent.tistory.com/entry/JavaScript-V8-%EC%97%94%EC%A7%84)